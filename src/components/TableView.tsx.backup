import { useState, useMemo } from 'react';
import type { APMachine } from '../types';
import { columns } from '../config/columns';
import './TableView.css';

interface Props {
  machines: APMachine[];
  selectedIds: Set<string>;
  onToggleSelection: (id: string) => void;
}

export default function TableView({ machines, selectedIds, onToggleSelection }: Props) {
  const [searchQuery, setSearchQuery] = useState('');
  const [sortBy, setSortBy] = useState<keyof APMachine | null>(null);
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('asc');
  const [currentPage, setCurrentPage] = useState(1);
  const [perPage, setPerPage] = useState(25);

  // Filter and search
  const filteredMachines = useMemo(() => {
    if (!searchQuery) return machines;
    
    const query = searchQuery.toLowerCase();
    return machines.filter(m =>
      String(m.model).toLowerCase().includes(query) ||
      String(m.manufacturer).toLowerCase().includes(query) ||
      String(m.frequency).toLowerCase().includes(query) ||
      String(m.wifi_standard).toLowerCase().includes(query) ||
      String(m.management_system).toLowerCase().includes(query)
    );
  }, [machines, searchQuery]);

  // Sort
  const sortedMachines = useMemo(() => {
    if (!sortBy) return filteredMachines;
    
    return [...filteredMachines].sort((a, b) => {
      const aVal = a[sortBy];
      const bVal = b[sortBy];
      
      if (aVal === undefined || aVal === null) return 1;
      if (bVal === undefined || bVal === null) return -1;
      
      let comparison = 0;
      if (typeof aVal === 'number' && typeof bVal === 'number') {
        comparison = aVal - bVal;
      } else {
        comparison = String(aVal).localeCompare(String(bVal));
      }
      
      return sortOrder === 'asc' ? comparison : -comparison;
    });
  }, [filteredMachines, sortBy, sortOrder]);

  // Paginate
  const paginatedMachines = useMemo(() => {
    const start = (currentPage - 1) * perPage;
    return sortedMachines.slice(start, start + perPage);
  }, [sortedMachines, currentPage, perPage]);

  const totalPages = Math.ceil(sortedMachines.length / perPage);

  const handleSort = (key: keyof APMachine) => {
    if (sortBy === key) {
      setSortOrder(prev => prev === 'asc' ? 'desc' : 'asc');
    } else {
      setSortBy(key);
      setSortOrder('asc');
    }
  };

  const formatValue = (value: any): string => {
    if (value === null || value === undefined) return '-';
    if (typeof value === 'boolean') return value ? 'Yes' : 'No';
    return String(value);
  };

  return (
    <div className="table-view container">
      <div className="table-controls">
        <div className="search-bar">
          <input
            type="text"
            placeholder="Search APs..."
            value={searchQuery}
            onChange={e => {
              setSearchQuery(e.target.value);
              setCurrentPage(1);
            }}
            className="search-input"
          />
        </div>
        
        <div className="table-info">
          Showing {paginatedMachines.length} of {sortedMachines.length} APs
          {selectedIds.size > 0 && ` (${selectedIds.size} selected)`}
        </div>
        
        <div className="pagination-controls">
          <label>
            Per page:
            <select value={perPage} onChange={e => {
              setPerPage(Number(e.target.value));
              setCurrentPage(1);
            }}>
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </label>
        </div>
      </div>

      <div className="table-container">
        <table className="ap-table">
          <thead>
            <tr>
              <th className="pinned-col">Select</th>
              {columns.map(col => (
                <th
                  key={String(col.key)}
                  className={col.pinned ? 'pinned-col' : ''}
                  onClick={() => col.sortable && handleSort(col.key)}
                  style={{ cursor: col.sortable ? 'pointer' : 'default', minWidth: col.width }}
                >
                  {col.label}
                  {sortBy === col.key && (sortOrder === 'asc' ? ' ↑' : ' ↓')}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {paginatedMachines.map(machine => (
              <tr
                key={machine.id}
                className={selectedIds.has(machine.id) ? 'selected' : ''}
              >
                <td className="pinned-col">
                  <button
                    onClick={() => onToggleSelection(machine.id)}
                    className={`select-btn ${selectedIds.has(machine.id) ? 'selected' : ''}`}
                  >
                    {selectedIds.has(machine.id) ? '✓' : '+'}
                  </button>
                </td>
                {columns.map(col => (
                  <td
                    key={String(col.key)}
                    className={col.pinned ? 'pinned-col' : ''}
                  >
                    {formatValue(machine[col.key])}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {totalPages > 1 && (
        <div className="pagination">
          <button
            onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
            disabled={currentPage === 1}
          >
            Previous
          </button>
          <span>
            Page {currentPage} of {totalPages}
          </span>
          <button
            onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
            disabled={currentPage === totalPages}
          >
            Next
          </button>
        </div>
      )}
    </div>
  );
}
